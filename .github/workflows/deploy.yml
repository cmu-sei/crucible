name: Release and Deploy Docs

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Determine base release tag
        id: release_tag
        run: echo "value=$(date +'%m.%d.%Y')" >> "$GITHUB_OUTPUT"

      - name: Compute release tag with index if needed
        id: tag_with_index
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const baseTag = `${{ toJSON(steps.release_tag.outputs.value) }}`;
            const regex = new RegExp(`^${baseTag}(?:-(\\d+))?$`);
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            let maxIndex = 0;
            let sawMatch = false;
            for (const release of releases) {
              const tag = release.tag_name;
              const match = tag ? regex.exec(tag) : null;
              if (!match) continue;
              sawMatch = true;
              const idx = match[1] ? parseInt(match[1], 10) : 0;
              if (!Number.isNaN(idx)) {
                maxIndex = Math.max(maxIndex, idx);
              }
            }

            const nextIndex = maxIndex + 1;
            const tagName = `${baseTag}-${nextIndex}`;
            core.info(`Using tag ${tagName} (base ${baseTag}; max existing index ${sawMatch ? maxIndex : 'none'}).`);
            core.setOutput('tag_name', tagName);

      - name: Create release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.tag_with_index.outputs.tag_name }}
          release_name: ${{ steps.tag_with_index.outputs.tag_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Deploy to GH Pages
      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
      - run: pip install mkdocs-material
      - run: mkdocs gh-deploy --force --clean --verbose
